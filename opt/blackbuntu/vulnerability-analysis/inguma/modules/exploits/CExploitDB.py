##      CExploitDB.py
#
#       Copyright 2010 Hugo Teso <hugo.teso@gmail.com>
#
#       This program is free software; you can redistribute it and/or modify
#       it under the terms of the GNU General Public License as published by
#       the Free Software Foundation; either version 2 of the License, or
#       (at your option) any later version.
#
#       This program is distributed in the hope that it will be useful,
#       but WITHOUT ANY WARRANTY; without even the implied warranty of
#       MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#       GNU General Public License for more details.
#
#       You should have received a copy of the GNU General Public License
#       along with this program; if not, write to the Free Software
#       Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
#       MA 02110-1301, USA.

import urllib, tarfile, os, string
from lib.module import CIngumaExploitModule

name = "exploitdb"
brief_description = "A module to fetch and manage exploits from exploit-db.com"
type = "exploit"

globals = ['search', 'xplpath', ]

class CExploitDB(CIngumaExploitModule):
    """Main class with run, help and summary methods"""

    search = ''
    port = ''
    xplpath = ''

    # Exploits will be saved on inguma's directory under data/exploits/
    # unless changed on EXPLOITS_DIR variable
    LOCAL_EXPLOIT_DIR = '/data/exploits/'
    INGUMA_DIR = os.getcwd()
    EXPLOITS_DIR = INGUMA_DIR + LOCAL_EXPLOIT_DIR

    # Local milw0rm exploits list
    EXPLOITS_LIST = EXPLOITS_DIR + 'files.csv'

    # List that will contain exploits list, format:
    #id, file, description, date, author, platform, type, port
    EXPLOITS = []

    def show_help(self):
        self.gom.echo()
        self.gom.echo("Inguma's Exploit-DB Help")
        self.gom.echo("------------------------")
        self.gom.echo()
        self.gom.echo("fetch                        Download exploits from exploit-db")

        if os.path.exists(self.EXPLOITS_DIR):
            self.gom.echo()
            self.gom.echo("Manage Exploit-DB commands")
            self.gom.echo("--------------------------")
            self.gom.echo()
            self.gom.echo("list                         Show list of local exploits. VERY VERBOSE")
            self.gom.echo("search <string>              Search exploits containing the string")
            self.gom.echo("                             Example: to search for postgre exploits")
            self.gom.echo("                             'search Postgre'")
            self.gom.echo("rport <port>                 Show exploits afecting a remote port")
            self.gom.echo("                             Define the port using command 'rport 22'")
            self.gom.echo("                             Port must be numeric: 22 intead of SSH")
            self.gom.echo("correlate                    Search the DB for all exploits matching rport")
            self.gom.echo("                             for all the ports of a scanned machine. Specify")
            self.gom.echo("                             target machine with 'target 192.168.0.1'")
            self.gom.echo("                             Be sure to scan the machine before!")
            self.gom.echo("show                         Show selected exploit source code")
            self.gom.echo("                             Select exploit using xplpath command:")
            self.gom.echo("                             'xplpath path/to/exploit'")
            self.gom.echo()

        self.gom.echo("help | h | ?                 Show this help")
        self.gom.echo("exit | quit | ..             Exit DB")
        self.gom.echo()

    def fetchExpl(self):
        # Exploits will be saved on inguma's directory under data/exploits/

        # Move to exploits directory
        try:
        	os.chdir(self.EXPLOITS_DIR)
        except(OSError):
        	os.mkdir(self.EXPLOITS_DIR)
        	os.chdir(self.EXPLOITS_DIR)
        self.gom.echo("Dir: ",self.EXPLOITS_DIR)

        # if exploits dir exists, it's considered an update
        if os.path.exists(self.EXPLOITS_DIR):
            self.gom.echo("exploit-db already downloaded, checking for updates")

        # Fetching exploits from milw0rm
        page = "http://www.exploit-db.com/archive.tar.bz2"
        self.gom.echo("Downloading ", page)
        urllib.urlretrieve(page, "archive.tar.bz2")

        # Extract exploits and remove original file
        self.gom.echo("Extracting files...")
        tar = tarfile.open("archive.tar.bz2")
        tar.extractall()
        tar.close()
        os.remove("archive.tar.bz2")
        os.chmod('files.csv', 0644)

        # Let's store actual date
        os.chdir(self.EXPLOITS_DIR)
        self.setDate()

        os.chdir(self.EXPLOITS_DIR)
        self.gom.echo("Operation Complete")

        # Load exploits
        self.loadExploits()

        os.chdir(self.INGUMA_DIR)

    def loadExploits(self):
        """ Parse files.csv and load contents into a list """

        import csv

        #Empty exploits list just in case is an update
        self.EXPLOITS = []

        os.chdir(self.EXPLOITS_DIR)
        file = open('files.csv', 'r')
        reader = csv.reader(file, delimiter=',')

        self.gom.echo("\nLoading exploits...")
        for row in reader:
            self.EXPLOITS.append(row)
        self.EXPLOITS.pop(0)
        self.gom.echo("Exploits loaded:", len(self.EXPLOITS))

        os.chdir(self.INGUMA_DIR)

    def setDate(self):
        """ Stores current date on a file """

        import time
        current_date = time.ctime(time.time())
        f = open('last_date.txt', 'w')
        f.write(current_date)
        f.close()
        self.gom.echo("Exploits successfully downloaded on", current_date)

    def readDate(self):
        """ Reads last date of exploits download """

        try:
            os.chdir(self.EXPLOITS_DIR)
        except:
            self.gom.echo("Exploits from exploit-db not yet downloaded")
            return False
        f = open('last_date.txt', 'r').read()
        os.chdir(self.INGUMA_DIR)
        return f

    def listExpl(self):
        """ Prints to stdout the exploits available """

        # Print descriptions of each exploit... verbose
        for exploit in self.EXPLOITS:
            self.gom.echo(self.LOCAL_EXPLOIT_DIR + exploit[1] + "\t\t" + exploit[2])

    def searchExpl(self):
        """ Search exploits containing the self.search string """

        # Check if self.search has content
        if self.search:
            self.gom.echo("Searching exploit-db for string:", self.search)
            for exploit in self.EXPLOITS:
                if exploit[2].__contains__(self.search):
                    self.gom.echo(self.LOCAL_EXPLOIT_DIR + exploit[1] + "\t\t" + exploit[2])
        else:
            self.gom.echo("Must specify a pattern to search for")
            self.gom.echo("Example: search Postgre")

    def correlate(self):
        """ Searches all exploits for each open port of a scanned machine """

        if self.target:
            targetPorts = self.target + '_tcp_ports'
            for port in self.user_data[targetPorts]:
                self.gom.echo("Searching exploit-db for port TCP/" + str(port))
                self.gom.echo()
                self.port = str(port)
                self.searchPort()

    def searchPort(self):
        """ Search exploits based on remote port """

        if self.port:
            self.gom.echo("Searching exploit-db for port:", self.port)
            for exploit in self.EXPLOITS:
                if exploit[-1] == self.port:
                    self.gom.echo(exploit[1] + "\t\t" + exploit[2])
        else:
            self.gom.echo("port variable is empty")
            self.gom.echo("Define the port using for example 'port 22'")

    def showExpl(self):
        """ Prints to stdout selected exploit """

        if self.xplpath:
            f = open(self.xplpath, 'r').read()
            self.gom.echo(f)
        else:
            self.gom.echo("Select a exploit to show")
            self.gom.echo("Use, for example, 'show ./modules/exploits/milw0rm/rport/22/1787.py'")

    def run(self):
        import lib.ui.cli.core as CLIcore

        # Try to read last download date
        last_date = self.readDate()
        if last_date:
            self.gom.echo("Last exploit-db update:", last_date)

        # if exploits list exists, load into memory
        if os.path.exists(self.EXPLOITS_LIST):
            self.gom.echo("exploit-db already downloaded, loading on memory")
            self.loadExploits()

        while 1:
            res = CLIcore.unified_input_prompt(self, 'exploitdb')
            if res == None:
                break

            words = res.split(" ")

            if len(words) == 1 and words[0] == "":
                continue
            elif words[0].lower() == "fetch":
                self.fetchExpl()
            elif words[0].lower() == "list":
                self.listExpl()
            elif words[0].lower() == "search":
                self.search = string.join(words[1:], ' ')
                self.searchExpl()
            elif words[0].lower() == "rport":
                self.port = str(words[1])
                self.searchPort()
            elif words[0].lower() == "correlate":
                self.correlate()
            elif words[0].lower() == "show":
                self.xplpath = str(words[1])
                self.showExpl()
            elif words[0].lower() == 'port':
                self.port = words[1]
                self.gom.echo("New search port: ", self.port)
            elif words[0].lower() == 'target':
                self.target = words[1]
                self.gom.echo("Target set for correlation:", self.target)
            else:
                self.gom.echo("Unknown command or options '" + str(res) + "'")

        return False
