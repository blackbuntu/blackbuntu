#!/bin/bash

function install_powershell() 
{
	sudo apt-get update
	sudo apt-get install -y apt-transport-https curl 
	curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
	curl https://packages.microsoft.com/config/ubuntu/18.04/prod.list | sudo tee /etc/apt/sources.list.d/microsoft.list
	sudo apt-get update
	sudo apt-get install -y powershell
	
	sudo mkdir -p /usr/local/share/powershell/Modules
	cp -r ../lib/powershell/Invoke-Obfuscation /usr/local/share/powershell/Modules
}

sudo -v

IFS='/' read -a array <<< pwd

if [[ "$(pwd)" != *setup ]]
then
    cd ./setup
fi

if ! which pip > /dev/null; then
	wget https://bootstrap.pypa.io/get-pip.py
	python get-pip.py
fi

sudo apt-get install -y make g++ python-dev python-m2crypto swig python-pip libxml2-dev default-jdk libssl1.0.0 libssl-dev build-essential
sudo -H pip install -r requirements.txt 
install_powershell

tar -xvf ../data/misc/xar-1.5.2.tar.gz
(cd xar-1.5.2 && ./configure)
(cd xar-1.5.2 && make)
(cd xar-1.5.2 && sudo make install)

git clone https://github.com/hogliux/bomutils.git
(cd bomutils && make)
(cd bomutils && make install)

if uname | grep -q "Linux"; then
	(cd bomutils && make install)
fi

chmod 755 bomutils/build/bin/mkbom && sudo cp bomutils/build/bin/mkbom /usr/local/bin/.
python ./setup_database.py
./cert.sh
cd ..
echo -e '\n [*] Setup complete!\n'
